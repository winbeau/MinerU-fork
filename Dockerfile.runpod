# =============================================================================
# MinerU RunPod Serverless Dockerfile
# 使用原生 mineru-api 服务，兼容 Dify MinerU 插件
# =============================================================================

# 基础镜像：vLLM (CUDA 支持)
# - v0.10.1.1: Ampere/Ada/Hopper (CC 8.0-9.0) - A100/A40/L40S/L4
# - v0.11.0: Volta/Turing/Blackwell (CC 7.0-8.0 或 >=10.0)
FROM vllm/vllm-openai:v0.10.1.1

LABEL maintainer="your-email@example.com"
LABEL description="MinerU PDF Parser for RunPod Serverless + Dify Integration"

# -----------------------------------------------------------------------------
# 环境变量
# -----------------------------------------------------------------------------
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    # MinerU 配置
    MINERU_MODEL_SOURCE=local \
    MINERU_LOG_LEVEL=INFO \
    MINERU_DEVICE_MODE=gpu \
    # API 配置
    MINERU_API_ENABLE_FASTAPI_DOCS=1 \
    MINERU_API_MAX_CONCURRENT_REQUESTS=2 \
    # 模型目录
    MINERU_MODELS_DIR=/runpod-volume/mineru_models \
    # 服务端口
    PORT=8000

# -----------------------------------------------------------------------------
# 系统依赖
# -----------------------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgl1 \
    libglib2.0-0 \
    fonts-noto-core \
    fonts-noto-cjk \
    fontconfig \
    curl \
    && fc-cache -fv \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# -----------------------------------------------------------------------------
# 安装 MinerU
# -----------------------------------------------------------------------------
WORKDIR /app

RUN python3 -m pip install --no-cache-dir -U \
    'mineru[core,vllm]>=2.7.0' \
    && python3 -m pip cache purge

# -----------------------------------------------------------------------------
# 复制启动脚本
# -----------------------------------------------------------------------------
COPY scripts/entrypoint.sh /app/entrypoint.sh
COPY scripts/download_models.sh /app/scripts/download_models.sh
RUN chmod +x /app/entrypoint.sh /app/scripts/download_models.sh

# -----------------------------------------------------------------------------
# 健康检查
# -----------------------------------------------------------------------------
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD curl -f http://localhost:${PORT}/docs || exit 1

# -----------------------------------------------------------------------------
# 端口
# -----------------------------------------------------------------------------
EXPOSE ${PORT}

# -----------------------------------------------------------------------------
# 启动命令：使用原生 mineru-api
# -----------------------------------------------------------------------------
ENTRYPOINT ["/app/entrypoint.sh"]
CMD ["mineru-api", "--host", "0.0.0.0", "--port", "8000"]
